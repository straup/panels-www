function panels_ui_success(a){alert(a)}function panels_ui_error(a){alert(a)}function panels_ui_confirm(a){return confirm(a)}function panels_ui_prompt(a,c){return prompt(a,c)}function panels_ui_show_controls(){var a=document.getElementById("header-controls"),c=document.getElementById("footer-controls");if(getComputedStyle(a).display=="none")a.style.display="inline";if(c&&getComputedStyle(c).display=="none")c.style.display="inline";return false}
function panels_ui_hide_controls(){var a=document.getElementById("header-controls"),c=document.getElementById("footer-controls");if(getComputedStyle(a).display!="none")a.style.display="none";if(c&&getComputedStyle(c).display!="none")c.style.display="none";return false};var sketchpad=null;function panels_init(){panels_new_panel();panels_load_panels();$("#header-upload").hide();panels_uploads_schedule_configured()&&panels_uploads_schedule_init()}function panels_new_panel(a,c){if(sketchpad){var b=sketchpad.json();if(!panels_is_empty(b))if(!panels_ui_confirm("You've started a sketch. Do you want to overwrite it?"))return false}return panels_load_panel(a,c)}
function panels_load_panel(a,c){var b={width:window.innerWidth,height:window.innerHeight,editing:true};if(a){try{var d=JSON.parse(a.data);b.strokes=d}catch(e){panels_ui_error("Failed to load that document because "+e);panels_ui_confirm("Should it be removed?")&&panels_delete_panel(c)}if(a.width&&a.width>b.width)b.width=a.width;if(a.height&&a.height>b.height)b.height=a.height}$("#editor").children().remove();sketchpad=Raphael.sketchpad("editor",b);b=sketchpad.pen();b.width(1);b.opacity(0.6);if(c){$("#editor").attr("data-panel-title",
c);$("#header-delete").show();$("#header-show").hide()}else{$("#editor").removeAttr("data-panel-title");$("#header-delete").hide()}$("#header-source").show();$("#header-editor").hide()}
function panels_save_panel(){var a=sketchpad.json();if(panels_is_empty(a)){panels_ui_error("There's nothing to save");return false}var c=$("#editor").attr("data-panel-title");c=panels_ui_prompt("What would you like to call this?",c);if(!c||c==""){panels_ui_error("You need to give this a name, silly.");return false}var b=$("#editor"),d=b.height();b=b.width();panels_storage_save(c,{data:a,height:d,width:b},function(){$("#editor").attr("data-panel-title",c);$("#header-delete").show();panels_load_panels()})}
function panels_load_panels(){panels_storage_list(function(a){for(var c=a.length,b='<option value="-1">opn</option>',d=/^pending_(.*)/,e=0;e<c;e++)if(!a[e].match(d)){b+='<option value="';b+=a[e];b+='">';b+=a[e];b+="</option>"}a=document.getElementById("load-sel");a.style.display="block";a.innerHTML=b;document.getElementById("header-select").style.display=c?"inline":"none"})}function panels_open_canvas(a){var c=a.value;panels_storage_load(c,function(b){panels_new_panel(b,c)})}
function panels_delete_panel(a){a||(a=$("#editor").attr("data-panel-title"));if(a){if(!panels_ui_confirm("Are you sure you want to delete "+a+"?"))return false;$("#editor").removeAttr("data-panel-title");panels_storage_remove(a,function(){panels_load_panels()})}else if(!panels_ui_confirm("Are you sure you want to delete this?"))return false;panels_load_panel()}
function panels_upload_panel(){if(typeof panels_custom_prepare_upload!="function"){panels_ui_error("uploads have not been configured");return false}var a=sketchpad.json();if(panels_is_empty(a)){panels_ui_error("there is nothing to upload");return false}a=panels_generate_svg(a);panels_uploads_schedule_upload(a)}
function panels_generate_svg(a){a=JSON.parse(a);var c=a.length,b='<?xml version="1.0" standalone="no"?>\n';b+='<svg xmlns="http://www.w3.org/2000/svg">\n';for(var d=0;d<c;d++){var e=a[d];b+='<path d="';b+=e.path;b+='" stroke="';b+=e.stroke;b+='" stroke-width="';b+=e["stroke-width"];b+='" stroke-opacity="';b+=e["stroke-opacity"];b+='" stroke-linecap="';b+=e["stroke-linecap"];b+='" stroke-linejoin="';b+=e["stroke-linejoin"];b+='" fill="';b+=e.fill;b+='" />\n'}b+="</svg>";return b}
function panels_view_source(){$("#editor").hide();$("#header-source").hide();$("#header-editor").show();var a=sketchpad.json();if(panels_is_empty(a))return false;a=panels_generate_svg(a);a=$("<div/>").text(a).html();$("#view-source").html(a);$("#view-source").show()}function panels_view_editor(){$("#view-source").html("");$("#view-source").hide();$("#editor").show();$("#header-source").show();$("#header-editor").hide()}
function panels_is_empty(a){if(!a)return true;if(typeof a=="string"&&a=="[]")return true;if(typeof a=="object"&&a.length==0)return true;return false};function panels_utils_data_uri_to_blob(a){var c;c=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var b=new Uint8Array(c.length),d=0;d<c.length;d++)b[d]=c.charCodeAt(d);return new Blob([b],{type:a})};function panels_storage_save(a,c,b){var d=(new Date).getTime();c.created=d;localforage.setItem(a,c,function(e){b&&b(e)})}function panels_storage_load(a,c){localforage.getItem(a,function(b){c&&c(b)})}function panels_storage_remove(a,c){localforage.removeItem(a,function(b){c&&c(b)})}function panels_storage_list(a){localforage.keys(a)};var panels_uploads_processing={};function panels_uploads_schedule_configured(){return typeof panels_custom_prepare_upload=="function"?true:false}function panels_uploads_schedule_init(){console.log("schedule uploads");$("#header-upload").show();setInterval(function(){panels_uploads_schedule_process_pending()},6E4);panels_uploads_schedule_process_pending()}
function panels_uploads_schedule_upload(a){if(typeof panels_custom_prepare_upload!="function"){panels_ui_error("Uploads are not configured");return false}var c="pending_"+window.btoa((new Date).toISOString());localforage.setItem(c,a,function(){panels_uploads_schedule_fetch(c)});return true}
function panels_uploads_schedule_fetch(a){if(!navigator.onLine)return false;if(panels_uploads_processing[a])return false;localforage.getItem(a,function(c){panels_uploads_processing[a]=true;try{var b=panels_utils_data_uri_to_blob(c)}catch(d){panels_ui_error("Ack! There was a problem preparing your sketch for uploading");console.log(d);return false}panels_custom_prepare_upload(b,function(e){panels_uploads_schedule_make_it_so(e.endpoint,e.formdata,a)});return true})}
function panels_uploads_schedule_make_it_so(a,c,b){var d=new XMLHttpRequest;d.open("POST",a,true);d.onload=function(){delete panels_uploads_processing[b];if(d.status==200){typeof panels_custom_upload_ok=="function"&&panels_custom_upload_ok(d);localforage.removeItem(b,function(){console.log("removed "+b)})}else console.log(b)};d.onerror=function(){delete panels_uploads_processing[b];panels_ui_error("Hrm... there was a problem contacting the remote server.")};d.send(c);return false}
function panels_uploads_schedule_process_pending(){var a=/^pending_.*/;panels_storage_list(function(c){for(var b=c.length,d=0;d<b;d++){var e=c[d];e.match(a)&&panels_uploads_schedule_fetch(e)}})};
